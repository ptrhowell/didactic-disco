<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/USDT Divergence Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a0f;
            --card-bg: #12121a;
            --card-border: #1e1e2e;
            --text-primary: #e0e0e0;
            --text-secondary: #7a7a8a;
            --text-muted: #444;
            --red: #ef4444;
            --orange: #f97316;
            --grey: #6b7280;
            --yellow: #eab308;
            --green: #22c55e;
            --red-bg: rgba(239, 68, 68, 0.06);
            --orange-bg: rgba(249, 115, 22, 0.06);
            --grey-bg: rgba(107, 114, 128, 0.04);
            --yellow-bg: rgba(234, 179, 8, 0.06);
            --green-bg: rgba(34, 197, 94, 0.06);
        }

        body {
            background: var(--bg);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 16px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--card-border);
        }

        .header h1 {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .price-block {
            text-align: center;
            margin-bottom: 24px;
        }

        .price-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .price-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            color: var(--text-primary);
        }

        .error-banner {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.25);
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 16px;
            font-size: 12px;
            color: var(--red);
            text-align: center;
            display: none;
        }

        .error-banner.visible { display: block; }

        .cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        @media (min-width: 768px) {
            .cards { flex-direction: row; }
            .card { flex: 1; }
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            border-left: 3px solid var(--card-border);
            transition: border-color 0.4s, background 0.4s;
        }

        .card[data-signal="strong-flush"]   { border-left-color: var(--red);    background: var(--red-bg); }
        .card[data-signal="mild-flush"]     { border-left-color: var(--orange); background: var(--orange-bg); }
        .card[data-signal="neutral"]        { border-left-color: var(--grey);   background: var(--grey-bg); }
        .card[data-signal="mild-squeeze"]   { border-left-color: var(--yellow); background: var(--yellow-bg); }
        .card[data-signal="strong-squeeze"] { border-left-color: var(--green);  background: var(--green-bg); }

        .card-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .tf-label {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: var(--text-muted);
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--grey);
            transition: background 0.4s, box-shadow 0.4s;
        }

        .card[data-signal="strong-flush"]   .dot { background: var(--red);    box-shadow: 0 0 8px var(--red); }
        .card[data-signal="mild-flush"]     .dot { background: var(--orange); box-shadow: 0 0 8px var(--orange); }
        .card[data-signal="neutral"]        .dot { background: var(--grey); }
        .card[data-signal="mild-squeeze"]   .dot { background: var(--yellow); box-shadow: 0 0 8px var(--yellow); }
        .card[data-signal="strong-squeeze"] .dot { background: var(--green);  box-shadow: 0 0 8px var(--green); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card:not([data-signal="neutral"]) .dot {
            animation: pulse 2s ease-in-out infinite;
        }

        .sig-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            transition: color 0.4s;
        }

        .card[data-signal="strong-flush"]   .sig-label { color: var(--red); }
        .card[data-signal="mild-flush"]     .sig-label { color: var(--orange); }
        .card[data-signal="neutral"]        .sig-label { color: var(--grey); }
        .card[data-signal="mild-squeeze"]   .sig-label { color: var(--yellow); }
        .card[data-signal="strong-squeeze"] .sig-label { color: var(--green); }

        .sig-reason {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
            min-height: 40px;
        }

        .stats {
            display: flex;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--card-border);
        }

        .stat { flex: 1; }

        .stat-lbl {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .stat-val {
            font-size: 13px;
            font-weight: 600;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
        }

        .stat-val.pos { color: var(--green); }
        .stat-val.neg { color: var(--red); }
        .stat-val.flat { color: var(--text-secondary); }

        .footer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--card-border);
        }

        .updated-text {
            font-size: 11px;
            color: var(--text-muted);
        }

        .refresh-btn {
            background: none;
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            padding: 5px 14px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
            font-family: inherit;
        }

        .refresh-btn:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .refresh-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .footnote {
            text-align: center;
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BTC / USDT Divergence Monitor</h1>
        </div>

        <div class="price-block">
            <div class="price-label">BTC / USDT Perp — Bybit</div>
            <div class="price-value" id="btcPrice">—</div>
        </div>

        <div class="error-banner" id="errBanner"></div>

        <div class="cards" id="cards"></div>

        <div class="footer">
            <span class="updated-text" id="updatedAt">Waiting for data…</span>
            <button class="refresh-btn" id="refreshBtn" onclick="refresh()">Refresh</button>
        </div>

        <div class="footnote">
            Funding thresholds: ±0.03 % (elevated) · ±0.05 % (extreme) — per 8 h settlement
        </div>
    </div>

<script>
// ════════════════════════════════════════════════════════
// CONFIG
// ════════════════════════════════════════════════════════
// If corsproxy.io is unreliable, swap this for your own
// Cloudflare Worker or set to '' if running without CORS.
const PROXY = 'https://corsproxy.io/?';
const BASE  = 'https://api.bybit.com';
const SYM   = 'BTCUSDT';
const REFRESH_MS = 60_000;

// Funding rate thresholds (raw decimal — 0.0005 = 0.05%)
const FR = { high: 0.0005, elevated: 0.0003, low: -0.0003, deep: -0.0005 };

// Per-timeframe divergence sensitivity
const DIV = {
    '1h':  { oi: 0.3, priceFlat: 0.2 },
    '4h':  { oi: 0.8, priceFlat: 0.5 },
    '24h': { oi: 1.5, priceFlat: 1.0 }
};

const TFS = [
    { label: '1 H',  key: '1h',  oiInt: '5min', oiN: 13, klInt: '60',  klN: 2 },
    { label: '4 H',  key: '4h',  oiInt: '1h',   oiN: 5,  klInt: '240', klN: 2 },
    { label: '24 H', key: '24h', oiInt: '4h',    oiN: 7,  klInt: 'D',   klN: 2 }
];

// ════════════════════════════════════════════════════════
// API — tries direct fetch first, falls back to CORS proxy
// ════════════════════════════════════════════════════════
let useProxy = false; // auto-detected on first call

async function api(path, params = {}) {
    const u = new URL(BASE + path);
    for (const [k, v] of Object.entries(params)) u.searchParams.set(k, v);
    const direct = u.toString();

    async function tryFetch(url) {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        if (j.retCode !== 0) throw new Error(j.retMsg || 'Bybit API error');
        return j.result;
    }

    if (useProxy) {
        return tryFetch(PROXY + encodeURIComponent(direct));
    }

    try {
        return await tryFetch(direct);
    } catch (e) {
        // CORS block — switch to proxy for this and all future calls
        useProxy = true;
        return tryFetch(PROXY + encodeURIComponent(direct));
    }
}

async function getFunding() {
    const d = await api('/v5/market/funding/history', { category: 'linear', symbol: SYM, limit: '1' });
    return parseFloat(d.list[0].fundingRate);
}

async function getTicker() {
    const d = await api('/v5/market/tickers', { category: 'linear', symbol: SYM });
    return parseFloat(d.list[0].lastPrice);
}

async function getOIChange(intervalTime, limit) {
    const d = await api('/v5/market/open-interest', { category: 'linear', symbol: SYM, intervalTime, limit: String(limit) });
    const l = d.list;
    if (l.length < 2) return 0;
    const now = parseFloat(l[0].openInterest);
    const old = parseFloat(l[l.length - 1].openInterest);
    return ((now - old) / old) * 100;
}

async function getPriceChange(interval, limit) {
    const d = await api('/v5/market/kline', { category: 'linear', symbol: SYM, interval, limit: String(limit) });
    const l = d.list;
    if (l.length < 2) return 0;
    const now = parseFloat(l[0][4]); // close
    const old = parseFloat(l[l.length - 1][4]);
    return ((now - old) / old) * 100;
}

// ════════════════════════════════════════════════════════
// SIGNAL LOGIC
// ════════════════════════════════════════════════════════
function fmt(rate) { return (rate * 100).toFixed(4) + '%'; }
function pct(v) { return (v > 0 ? '+' : '') + v.toFixed(2) + '%'; }

function classify(fr, oiPct, pxPct, tfKey) {
    const t = DIV[tfKey];
    const oiUp   = oiPct >  t.oi;
    const oiDown = oiPct < -t.oi;
    const pxFlat = Math.abs(pxPct) < t.priceFlat;
    const pxDown = pxPct < -t.priceFlat;
    const pxUp   = pxPct >  t.priceFlat;

    // ── FLUSH (long liquidation) scenarios ──
    if (fr >= FR.high && oiUp && (pxFlat || pxDown)) {
        return {
            sig: 'strong-flush', label: 'Strong Flush Risk',
            why: `Funding at ${fmt(fr)}, OI up ${pct(oiPct)} but price ${pxDown ? 'falling' : 'stalling'} — long liquidation risk.`
        };
    }
    if (fr >= FR.elevated && oiUp && !pxUp) {
        return {
            sig: 'mild-flush', label: 'Mild Flush Risk',
            why: `Funding above neutral at ${fmt(fr)}, OI expanding without price follow-through — early flush setup.`
        };
    }
    if (fr >= FR.high && pxUp && !oiDown) {
        return {
            sig: 'mild-flush', label: 'Mild Flush Risk',
            why: `Funding high at ${fmt(fr)} with price still rising — overextension building, flush risk if momentum fades.`
        };
    }

    // ── SQUEEZE (short liquidation) scenarios ──
    if (fr <= FR.deep && oiUp && pxUp) {
        return {
            sig: 'strong-squeeze', label: 'Strong Squeeze Signal',
            why: `Funding deeply negative at ${fmt(fr)}, shorts paying while price pushes ${pct(pxPct)} — short squeeze conditions.`
        };
    }
    if (fr <= FR.low && (oiUp || pxUp)) {
        return {
            sig: 'mild-squeeze', label: 'Mild Squeeze Building',
            why: `Funding negative at ${fmt(fr)}, ${oiUp ? 'OI expanding' : 'price rising'} — shorts under pressure.`
        };
    }
    if (fr <= FR.deep && pxDown) {
        return {
            sig: 'mild-squeeze', label: 'Mild Squeeze Building',
            why: `Funding deeply negative at ${fmt(fr)} while price still falling — aggressive shorts, snap-back risk growing.`
        };
    }

    // ── NEUTRAL ──
    return {
        sig: 'neutral', label: 'Neutral',
        why: `No significant divergence — funding ${fmt(fr)}, OI ${pct(oiPct)}, price ${pct(pxPct)}.`
    };
}

// ════════════════════════════════════════════════════════
// RENDER
// ════════════════════════════════════════════════════════
const $cards   = document.getElementById('cards');
const $price   = document.getElementById('btcPrice');
const $updated = document.getElementById('updatedAt');
const $err     = document.getElementById('errBanner');
const $btn     = document.getElementById('refreshBtn');

function valClass(v) { return v > 0.001 ? 'pos' : v < -0.001 ? 'neg' : 'flat'; }

function renderCards(rows) {
    $cards.innerHTML = rows.map(r => `
        <div class="card" data-signal="${r.sig}">
            <div class="card-top">
                <span class="tf-label">${r.tf}</span>
                <div class="dot"></div>
            </div>
            <div class="sig-label">${r.label}</div>
            <div class="sig-reason">${r.why}</div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-lbl">Funding</div>
                    <div class="stat-val ${valClass(r.fr)}">${fmt(r.fr)}</div>
                </div>
                <div class="stat">
                    <div class="stat-lbl">OI Chg</div>
                    <div class="stat-val ${valClass(r.oi)}">${pct(r.oi)}</div>
                </div>
                <div class="stat">
                    <div class="stat-lbl">Price Chg</div>
                    <div class="stat-val ${valClass(r.px)}">${pct(r.px)}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderSkeleton() {
    $cards.innerHTML = TFS.map(t => `
        <div class="card" data-signal="neutral">
            <div class="card-top">
                <span class="tf-label">${t.label}</span>
                <div class="dot"></div>
            </div>
            <div class="sig-label" style="color:var(--text-muted)">Loading…</div>
            <div class="sig-reason">Fetching from Bybit…</div>
            <div class="stats">
                <div class="stat"><div class="stat-lbl">Funding</div><div class="stat-val flat">—</div></div>
                <div class="stat"><div class="stat-lbl">OI Chg</div><div class="stat-val flat">—</div></div>
                <div class="stat"><div class="stat-lbl">Price Chg</div><div class="stat-val flat">—</div></div>
            </div>
        </div>
    `).join('');
}

function showErr(msg) { $err.textContent = msg; $err.classList.add('visible'); }
function hideErr()    { $err.classList.remove('visible'); }

// ════════════════════════════════════════════════════════
// REFRESH
// ════════════════════════════════════════════════════════
let timer = null;

async function refresh() {
    $btn.disabled = true;
    $btn.textContent = 'Loading…';
    hideErr();

    try {
        // Fetch all raw data in parallel
        const [fr, price, ...oiPxPairs] = await Promise.all([
            getFunding(),
            getTicker(),
            ...TFS.map(tf => Promise.all([
                getOIChange(tf.oiInt, tf.oiN),
                getPriceChange(tf.klInt, tf.klN)
            ]))
        ]);

        // Compute signals now that all data is available
        const rows = TFS.map((tf, i) => {
            const [oi, px] = oiPxPairs[i];
            const s = classify(fr, oi, px, tf.key);
            return { tf: tf.label, fr, oi, px, ...s };
        });

        $price.textContent = '$' + price.toLocaleString(undefined, {
            minimumFractionDigits: 2, maximumFractionDigits: 2
        });

        renderCards(rows);
        $updated.textContent = 'Updated ' + new Date().toLocaleTimeString();

    } catch (e) {
        console.error('Refresh failed:', e);
        showErr('Data fetch failed — ' + e.message + '. Retrying in 60 s.');
    }

    $btn.disabled = false;
    $btn.textContent = 'Refresh';
}

// ════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════
renderSkeleton();
refresh();
timer = setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
