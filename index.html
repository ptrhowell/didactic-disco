<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Altcoin Scanner v2</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e17;--card:#111827;--card-hover:#1a2235;--border:#1f2937;
  --text:#e5e7eb;--text-dim:#6b7280;--text-bright:#f9fafb;
  --green:#10b981;--green-bg:rgba(16,185,129,0.1);
  --red:#ef4444;--red-bg:rgba(239,68,68,0.1);
  --amber:#f59e0b;--amber-bg:rgba(245,158,11,0.08);
  --blue:#3b82f6;--purple:#8b5cf6;
}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}

.container{max-width:1100px;margin:0 auto;padding:16px}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--border);margin-bottom:16px;flex-wrap:wrap;gap:12px}
.header-left{display:flex;align-items:center;gap:12px}
.logo{font-size:18px;font-weight:700;color:var(--text-bright);letter-spacing:-0.5px}
.logo span{color:var(--amber)}
.version{font-size:10px;color:var(--text-dim);background:var(--card);border:1px solid var(--border);border-radius:4px;padding:1px 5px;vertical-align:middle}
.header-right{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.last-update{font-size:12px;color:var(--text-dim)}
.btn{padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:var(--card-hover);border-color:#374151}
.btn.active{border-color:var(--green);color:var(--green)}
.btn .dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.countdown{font-variant-numeric:tabular-nums;color:var(--text-dim);font-size:12px;min-width:32px}

/* Context Bar */
.context-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
.context-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.context-label{font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.context-value{font-size:20px;font-weight:600;color:var(--text-bright);font-variant-numeric:tabular-nums}
.context-sub{font-size:12px;margin-top:2px}
.pos{color:var(--green)}.neg{color:var(--red)}.neutral{color:var(--text-dim)}.warn{color:var(--amber)}

/* Condition Banner */
.cond-banner{padding:10px 16px;border-radius:8px;margin-bottom:16px;font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px}
.cond-normal{background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);color:var(--green)}
.cond-moderate{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);color:var(--amber)}
.cond-low{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:var(--red)}
.cond-extreme{background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);color:#fca5a5}

/* Section Titles */
.section-title{font-size:13px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.section-title .count{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1px 8px;font-size:11px}
.section-title .hint{font-weight:400;font-size:11px;text-transform:none;letter-spacing:0;color:#4b5563}

/* Watchlist */
.watchlist-section{margin-bottom:20px}
.watchlist-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.watchlist-grid{display:flex;gap:8px;flex-wrap:wrap}
.wl-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 12px;min-width:100px;cursor:pointer;transition:all 0.15s;position:relative}
.wl-card:hover{background:var(--card-hover);border-color:#374151}
.wl-card .wl-sym{font-size:13px;font-weight:700;color:var(--text-bright)}
.wl-card .wl-row{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:11px;font-variant-numeric:tabular-nums}
.wl-card .wl-score{font-weight:700;font-size:14px}
.wl-card .wl-dir{font-size:10px;font-weight:700;padding:1px 5px;border-radius:3px}
.wl-card .wl-dir.long{background:var(--green-bg);color:var(--green)}
.wl-card .wl-dir.short{background:var(--red-bg);color:var(--red)}
.wl-remove{position:absolute;top:4px;right:6px;background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;opacity:0;transition:opacity 0.15s;padding:2px}
.wl-card:hover .wl-remove{opacity:1}
.wl-empty{font-size:12px;color:var(--text-dim);padding:8px 0}

/* Setup Cards */
.setups{display:flex;flex-direction:column;gap:12px;margin-bottom:24px}
.setup-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px 20px;transition:all 0.2s;position:relative;overflow:hidden}
.setup-card:hover{background:var(--card-hover);border-color:#374151}
.setup-card.long{border-left:3px solid var(--green)}
.setup-card.short{border-left:3px solid var(--red)}
.setup-card.is-new{animation:glow 2.5s ease-in-out infinite}
@keyframes glow{0%,100%{box-shadow:0 0 6px rgba(245,158,11,0.15)}50%{box-shadow:0 0 18px rgba(245,158,11,0.35)}}
.setup-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;flex-wrap:wrap;gap:8px}
.setup-left{display:flex;align-items:center;gap:12px}
.dir-badge{padding:3px 10px;border-radius:4px;font-size:11px;font-weight:700;letter-spacing:0.5px}
.dir-badge.long{background:var(--green-bg);color:var(--green)}
.dir-badge.short{background:var(--red-bg);color:var(--red)}
.setup-sym{font-size:18px;font-weight:700;color:var(--text-bright)}
.setup-sym small{font-size:13px;font-weight:400;color:var(--text-dim)}
.setup-score{text-align:right}
.score-val{font-size:22px;font-weight:700;font-variant-numeric:tabular-nums}
.score-val.long{color:var(--green)}.score-val.short{color:var(--red)}
.score-lbl{font-size:10px;color:var(--text-dim);text-transform:uppercase}
.score-bar{width:80px;height:4px;background:#1f2937;border-radius:2px;margin-top:4px;overflow:hidden;margin-left:auto}
.score-bar-fill{height:100%;border-radius:2px;transition:width 0.5s}
.score-bar-fill.long{background:var(--green)}.score-bar-fill.short{background:var(--red)}
.trend-line{font-size:11px;color:var(--text-dim);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.trend-line .new-tag{color:var(--amber);font-weight:600}
.trend-line .trend-arrow{font-weight:700}
.trend-line .trend-arrow.up{color:var(--green)}.trend-line .trend-arrow.down{color:var(--red)}
.setup-rationale{font-size:14px;color:var(--text);margin-bottom:14px;line-height:1.5;font-style:italic}
.setup-metrics{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.metric{background:rgba(255,255,255,0.02);border-radius:6px;padding:7px 9px}
.metric-label{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.3px}
.metric-value{font-size:13px;font-weight:600;font-variant-numeric:tabular-nums;margin-top:1px}
.metric-sub{font-size:9px;color:var(--text-dim);margin-top:1px}
.card-actions{display:flex;gap:8px;margin-top:12px}
.card-actions .btn{font-size:11px;padding:4px 10px}
.dismiss-btn{position:absolute;top:10px;right:12px;background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;padding:4px;line-height:1;opacity:0;transition:opacity 0.15s}
.setup-card:hover .dismiss-btn{opacity:1}
.dismiss-btn:hover{color:var(--text)}

/* No Setups */
.no-setups{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:40px 20px;text-align:center;margin-bottom:24px}
.no-setups h3{color:var(--text-dim);font-size:16px;margin-bottom:6px}
.no-setups p{color:var(--text-dim);font-size:13px}

/* Near Misses */
.near-misses{margin-bottom:24px;background:var(--card);border:1px solid var(--border);border-left:3px solid var(--amber);border-radius:10px;padding:14px 16px}
.near-misses h4{font-size:12px;color:var(--amber);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.nm-item{display:flex;align-items:center;gap:10px;padding:5px 0;font-size:13px}
.nm-sym{font-weight:700;color:var(--text-bright);min-width:50px}
.nm-score{font-size:12px;color:var(--text-dim);font-variant-numeric:tabular-nums;min-width:45px}
.nm-reason{color:var(--text-dim);font-size:12px;flex:1}

/* Heatmap */
.heatmap-section{margin-bottom:24px}
.heatmap-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(68px,1fr));gap:4px}
.hm-cell{border-radius:6px;padding:6px 4px;text-align:center;cursor:pointer;transition:transform 0.1s;position:relative}
.hm-cell:hover{transform:scale(1.08);z-index:1}
.hm-cell .hm-sym{font-weight:600;color:rgba(255,255,255,0.9);font-size:11px}
.hm-cell .hm-rate{font-size:9px;opacity:0.8;margin-top:1px;font-variant-numeric:tabular-nums}
.heatmap-legend{display:flex;align-items:center;gap:6px;margin-top:8px;font-size:10px;color:var(--text-dim)}
.heatmap-legend .lg-bar{height:8px;flex:1;max-width:200px;border-radius:4px;background:linear-gradient(to right,var(--green),#1f2937,var(--red))}

/* Heatmap Popover */
.hm-popover{position:fixed;z-index:500;background:#1a2332;border:1px solid #374151;border-radius:10px;padding:14px 16px;min-width:220px;box-shadow:0 8px 30px rgba(0,0,0,0.5);display:none}
.hm-popover.visible{display:block}
.hm-popover .pop-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.hm-popover .pop-sym{font-size:15px;font-weight:700;color:var(--text-bright)}
.hm-popover .pop-close{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px}
.hm-popover .pop-row{display:flex;justify-content:space-between;font-size:12px;padding:3px 0}
.hm-popover .pop-label{color:var(--text-dim)}
.hm-popover .pop-val{font-weight:600;font-variant-numeric:tabular-nums}
.hm-popover .pop-actions{margin-top:10px;display:flex;gap:6px}

/* Altseason + Dominance */
.bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
@media(max-width:640px){.bottom-grid{grid-template-columns:1fr}}
.info-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
.info-card h4{font-size:12px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.gauge-row{display:flex;align-items:center;gap:12px}
.gauge-bar{flex:1;height:10px;background:#1f2937;border-radius:5px;overflow:hidden}
.gauge-fill{height:100%;border-radius:5px;transition:width 0.5s}
.gauge-val{font-size:20px;font-weight:700}
.dom-val{font-size:28px;font-weight:700;color:var(--text-bright);font-variant-numeric:tabular-nums}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:600;display:none;justify-content:center;align-items:center}
.modal-overlay.visible{display:flex}
.modal-box{background:#1a2332;border:1px solid #374151;border-radius:12px;padding:20px;width:90%;max-width:360px;max-height:70vh;overflow-y:auto}
.modal-box h3{font-size:15px;color:var(--text-bright);margin-bottom:12px}
.modal-search{width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;outline:none}
.modal-search:focus{border-color:var(--blue)}
.modal-results{margin-top:8px;max-height:200px;overflow-y:auto}
.modal-item{padding:8px 10px;border-radius:6px;cursor:pointer;font-size:13px;display:flex;justify-content:space-between;align-items:center}
.modal-item:hover{background:var(--card)}
.modal-item .mi-sym{font-weight:600;color:var(--text-bright)}
.modal-item .mi-name{color:var(--text-dim);font-size:11px}

/* Loading + Error */
.loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;transition:opacity 0.3s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--amber);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:14px;font-size:13px;color:var(--text-dim)}
.error-toast{position:fixed;bottom:20px;right:20px;background:#1f2937;border:1px solid var(--red);border-radius:8px;padding:10px 16px;font-size:12px;color:var(--red);z-index:800;opacity:0;transform:translateY(10px);transition:all 0.3s;pointer-events:none}
.error-toast.show{opacity:1;transform:translateY(0)}

/* Footer */
.footer{text-align:center;padding:16px 0;font-size:11px;color:var(--text-dim);border-top:1px solid var(--border)}
.footer code{background:#1f2937;padding:2px 6px;border-radius:3px}

/* Responsive */
@media(max-width:600px){
  .container{padding:10px}
  .context-bar{grid-template-columns:1fr 1fr}
  .setup-metrics{grid-template-columns:repeat(3,1fr)}
  .context-value{font-size:16px}
  .setup-sym{font-size:16px}
  .score-val{font-size:18px}
  .heatmap-grid{grid-template-columns:repeat(auto-fill,minmax(54px,1fr))}
  .watchlist-grid{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .wl-card{min-width:90px;flex-shrink:0}
}
</style>
</head>
<body>

<div class="loading-overlay" id="loader">
  <div class="spinner"></div>
  <div class="loading-text">Scanning markets...</div>
</div>
<div class="error-toast" id="errorToast"></div>
<div class="hm-popover" id="hmPopover"></div>
<div class="modal-overlay" id="wlModal">
  <div class="modal-box">
    <h3>Add to Watchlist</h3>
    <input class="modal-search" id="wlSearch" placeholder="Search symbol..." autocomplete="off">
    <div class="modal-results" id="wlResults"></div>
    <div style="margin-top:10px;text-align:right"><button class="btn" onclick="closeModal()">Close</button></div>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="header-left">
      <div class="logo"><span>&#9670;</span> ALTCOIN SCANNER <span class="version">v2</span></div>
    </div>
    <div class="header-right">
      <span class="last-update" id="lastUpdate"></span>
      <span class="countdown" id="countdown"></span>
      <button class="btn active" id="autoBtn" onclick="toggleAuto()"><span class="dot"></span> Auto</button>
      <button class="btn" id="refreshBtn" onclick="manualRefresh()">Refresh</button>
    </div>
  </div>

  <div class="context-bar" id="contextBar"></div>
  <div id="condBanner"></div>

  <div id="watchlistSection"></div>

  <div class="section-title">Today's Setups <span class="count" id="setupCount">0</span></div>
  <div class="setups" id="setups"></div>

  <div id="nearMisses"></div>

  <div class="heatmap-section">
    <div class="section-title">Funding Heatmap <span class="hint">(click any coin for details)</span></div>
    <div class="heatmap-grid" id="heatmap"></div>
    <div class="heatmap-legend"><span>Shorts pay (Long opp.)</span><div class="lg-bar"></div><span>Longs pay (Short opp.)</span></div>
  </div>

  <div class="bottom-grid">
    <div class="info-card">
      <h4>Altseason Index</h4>
      <div class="gauge-row"><div class="gauge-bar"><div class="gauge-fill" id="altFill"></div></div><div class="gauge-val" id="altVal">—</div></div>
      <div style="font-size:12px;color:var(--text-dim);margin-top:6px" id="altLabel"></div>
    </div>
    <div class="info-card">
      <h4>BTC Dominance</h4>
      <div class="dom-val" id="domVal">—</div>
      <div style="font-size:12px;margin-top:4px" id="domNote"></div>
    </div>
  </div>

  <div class="footer">
    <span id="proxyNote"></span>Data from Binance &amp; CoinGecko &middot; Not financial advice &middot; Auto-refreshes every 5 min<br>
    <span style="opacity:0.6">Serve locally: <code>python3 -m http.server</code> then open <code>localhost:8000</code></span>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════
//  CONFIG
// ═══════════════════════════════════════════════════════
const C = {
  REFRESH: 300000,
  MAX_SETUPS: 5,
  BASE_THRESHOLD: 30,
  W: { rs: 0.30, funding: 0.25, vol: 0.20, oi: 0.10, mom: 0.15 },
  EXCLUDE: new Set(['USDT','USDC','BUSD','DAI','TUSD','FDUSD','USDP','USDD','PYUSD','WBTC','WETH','STETH','WSTETH','CBETH','RETH','WEETH','EZETH','MSOL','BNSOL']),
  API: {
    spot24: 'https://api.binance.com/api/v3/ticker/24hr',
    spot1h: 'https://api.binance.com/api/v3/ticker?windowSize=1h',
    spot4h: 'https://api.binance.com/api/v3/ticker?windowSize=4h',
    futFund: 'https://fapi.binance.com/fapi/v1/premiumIndex',
    fut24: 'https://fapi.binance.com/fapi/v1/ticker/24hr',
    cgMarkets: 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false',
    cgDerivs: 'https://api.coingecko.com/api/v3/derivatives',
    cgGlobal: 'https://api.coingecko.com/api/v3/global',
    fng: 'https://api.alternative.me/fng/?limit=1'
  },
  SNAP_MAX: 288,
  SNAP_TTL: 86400000
};

// ═══════════════════════════════════════════════════════
//  HISTORY MANAGER (localStorage snapshots)
// ═══════════════════════════════════════════════════════
const History = {
  _key: 'scanner_v2_snaps',
  _cache: null,

  _load() {
    if (this._cache) return this._cache;
    try { this._cache = JSON.parse(localStorage.getItem(this._key)) || {}; }
    catch { this._cache = {}; }
    return this._cache;
  },

  save(symbol, snap) {
    const db = this._load();
    if (!db[symbol]) db[symbol] = [];
    db[symbol].push(snap);
    const cutoff = Date.now() - C.SNAP_TTL;
    db[symbol] = db[symbol].filter(s => s.ts > cutoff).slice(-C.SNAP_MAX);
    this._cache = db;
    try { localStorage.setItem(this._key, JSON.stringify(db)); } catch {}
  },

  recent(symbol, n = 6) {
    const db = this._load();
    const arr = db[symbol] || [];
    return arr.slice(-n);
  },

  prev(symbol) {
    const arr = this.recent(symbol, 2);
    return arr.length >= 2 ? arr[arr.length - 2] : null;
  },

  trend(symbol, threshold) {
    const db = this._load();
    const arr = db[symbol] || [];
    if (arr.length === 0) return { isNew: true, age: 0, scoreDelta: 0, label: 'New' };
    const first = arr.find(s => Math.abs(s.score) >= threshold);
    const last = arr[arr.length - 1];
    const prev = arr.length >= 2 ? arr[arr.length - 2] : last;
    const age = first ? Date.now() - first.ts : 0;
    const delta = last.score - prev.score;
    let label = 'Steady';
    if (!first || age < 900000) label = 'New';
    else if (age < 3600000) label = 'Developing';
    else label = 'Established';
    return { isNew: label === 'New', age, scoreDelta: delta, label };
  },

  prune() {
    const db = this._load();
    const cutoff = Date.now() - C.SNAP_TTL;
    for (const sym of Object.keys(db)) {
      db[sym] = db[sym].filter(s => s.ts > cutoff);
      if (db[sym].length === 0) delete db[sym];
    }
    this._cache = db;
    try { localStorage.setItem(this._key, JSON.stringify(db)); } catch {}
  }
};

// ═══════════════════════════════════════════════════════
//  WATCHLIST MANAGER
// ═══════════════════════════════════════════════════════
const Watchlist = {
  _key: 'scanner_v2_wl',
  _list: null,

  _load() {
    if (this._list) return this._list;
    try { this._list = JSON.parse(localStorage.getItem(this._key)) || []; }
    catch { this._list = []; }
    return this._list;
  },

  getAll() { return this._load(); },
  has(sym) { return this._load().includes(sym); },

  add(sym) {
    const list = this._load();
    if (!list.includes(sym)) { list.push(sym); this._save(); }
  },

  remove(sym) {
    this._list = this._load().filter(s => s !== sym);
    this._save();
  },

  _save() { try { localStorage.setItem(this._key, JSON.stringify(this._list)); } catch {} }
};

// ═══════════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════════
let S = {
  auto: true, timer: null, nextRefresh: 0,
  excluded: (() => { try { return JSON.parse(localStorage.getItem('scanner_v2_excl')) || []; } catch { return []; } })(),
  raw: null, result: null, allScored: null,
  usingProxy: false
};

// ═══════════════════════════════════════════════════════
//  DATA FETCHING
// ═══════════════════════════════════════════════════════
const PROXIES = [
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u => `https://corsproxy.io/?${encodeURIComponent(u)}`
];

async function fetchJSON(url) {
  try { const r = await fetch(url); if (r.ok) return r.json(); } catch {}
  for (const px of PROXIES) {
    try { const r = await fetch(px(url)); if (r.ok) { S.usingProxy = true; return r.json(); } } catch {}
  }
  return null;
}

async function fetchAll() {
  S.usingProxy = false;
  const [spot24, spot1h, spot4h, funding, fut24, cgMkt, cgDeriv, cgGlob, fng] =
    await Promise.all([
      fetchJSON(C.API.spot24),
      fetchJSON(C.API.spot1h),
      fetchJSON(C.API.spot4h),
      fetchJSON(C.API.futFund),
      fetchJSON(C.API.fut24),
      fetchJSON(C.API.cgMarkets),
      fetchJSON(C.API.cgDerivs),
      fetchJSON(C.API.cgGlobal),
      fetchJSON(C.API.fng)
    ]);
  return { spot24, spot1h, spot4h, funding, fut24, cgMkt, cgDeriv, cgGlob, fng };
}

// ═══════════════════════════════════════════════════════
//  HELPERS
// ═══════════════════════════════════════════════════════
function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
function sign(v) { return v >= 0 ? 1 : -1; }
function pct(v) { return v >= 0 ? '+' + v.toFixed(2) + '%' : v.toFixed(2) + '%'; }
function mapToObj(arr, keyFn) {
  const m = {};
  if (!arr) return m;
  arr.forEach(item => { const k = keyFn(item); if (k) m[k] = item; });
  return m;
}
function timeAgo(ms) {
  if (ms < 60000) return 'just now';
  if (ms < 3600000) return Math.floor(ms / 60000) + ' min ago';
  return Math.floor(ms / 3600000) + 'h ago';
}

// ═══════════════════════════════════════════════════════
//  ANALYSIS ENGINE
// ═══════════════════════════════════════════════════════

function analyze(raw) {
  // --- Build lookup maps ---
  const spot24Map = mapToObj(raw.spot24, t => t.symbol.endsWith('USDT') ? t.symbol : null);
  const spot1hMap = mapToObj(raw.spot1h, t => t.symbol.endsWith('USDT') ? t.symbol : null);
  const spot4hMap = mapToObj(raw.spot4h, t => t.symbol.endsWith('USDT') ? t.symbol : null);
  const fundMap = mapToObj(raw.funding, f => f.symbol.endsWith('USDT') ? f.symbol : null);
  const fut24Map = mapToObj(raw.fut24, t => t.symbol.endsWith('USDT') ? t.symbol : null);

  // OI map from CoinGecko derivatives
  const oiMap = {};
  if (raw.cgDeriv) {
    raw.cgDeriv.forEach(d => {
      if (d.market && d.market.toLowerCase().includes('binance') && d.contract_type === 'perpetual') {
        const sym = (d.symbol || '').replace('/','').replace('-','').toUpperCase();
        if (sym.endsWith('USDT') || sym.endsWith('USD')) {
          const base = sym.replace(/USDT?$/, '');
          oiMap[base] = { oi: d.open_interest || 0, fundingCG: d.funding_rate || 0 };
        }
      }
    });
  }

  // --- BTC Context ---
  const btcSpot24 = spot24Map['BTCUSDT'];
  const btcSpot1h = spot1hMap['BTCUSDT'];
  const btcSpot4h = spot4hMap['BTCUSDT'];
  const btcFut = fut24Map['BTCUSDT'];
  const btcFund = fundMap['BTCUSDT'];

  const btc = {
    price: btcSpot24 ? parseFloat(btcSpot24.lastPrice) : 0,
    ch24: btcSpot24 ? parseFloat(btcSpot24.priceChangePercent) : 0,
    ch4h: btcSpot4h ? parseFloat(btcSpot4h.priceChangePercent) : 0,
    ch1h: btcSpot1h ? parseFloat(btcSpot1h.priceChangePercent) : 0,
    high24: btcSpot24 ? parseFloat(btcSpot24.highPrice) : 0,
    low24: btcSpot24 ? parseFloat(btcSpot24.lowPrice) : 0,
    range: 0,
    funding: btcFund ? parseFloat(btcFund.lastFundingRate) * 100 : 0,
    dom: raw.cgGlob?.data?.market_cap_percentage?.btc || 0,
    fgVal: raw.fng?.data?.[0]?.value ? parseInt(raw.fng.data[0].value) : 0,
    fgLabel: raw.fng?.data?.[0]?.value_classification || ''
  };
  btc.range = btc.price > 0 ? ((btc.high24 - btc.low24) / btc.price) * 100 : 0;

  // --- Market Condition ---
  let condition = 'normal', threshold = C.BASE_THRESHOLD;
  if (btc.range < 2) { condition = 'low'; threshold = 50; }
  else if (btc.range < 4) { condition = 'moderate'; threshold = 40; }

  // --- Build Universe ---
  const coins = [];
  if (raw.cgMkt) {
    raw.cgMkt.forEach(cg => {
      const sym = cg.symbol.toUpperCase();
      if (sym === 'BTC' || C.EXCLUDE.has(sym) || S.excluded.includes(sym)) return;
      const pair = sym + 'USDT';
      const s24 = spot24Map[pair], s1h = spot1hMap[pair], s4h = spot4hMap[pair];
      const f24 = fut24Map[pair], fund = fundMap[pair];
      if (!f24 && !s24) return;

      coins.push({
        sym, pair, name: cg.name, image: cg.image, mcap: cg.market_cap_rank || 999,
        price: cg.current_price,
        ch24: s24 ? parseFloat(s24.priceChangePercent) : (cg.price_change_percentage_24h || 0),
        ch4h: s4h ? parseFloat(s4h.priceChangePercent) : null,
        ch1h: s1h ? parseFloat(s1h.priceChangePercent) : null,
        vol24: s24 ? parseFloat(s24.quoteVolume) : 0,
        vol4h: s4h ? parseFloat(s4h.quoteVolume) : null,
        vol1h: s1h ? parseFloat(s1h.quoteVolume) : null,
        futHigh: f24 ? parseFloat(f24.highPrice) : (s24 ? parseFloat(s24.highPrice) : 0),
        futLow: f24 ? parseFloat(f24.lowPrice) : (s24 ? parseFloat(s24.lowPrice) : 0),
        futClose: f24 ? parseFloat(f24.lastPrice) : (s24 ? parseFloat(s24.lastPrice) : 0),
        fundingRate: fund ? parseFloat(fund.lastFundingRate) : 0,
        fundingPct: fund ? parseFloat(fund.lastFundingRate) * 100 : 0,
        oi: oiMap[sym]?.oi || 0,
        hasFutures: !!fund
      });
    });
  }

  if (coins.length === 0) return { btc, condition, threshold, setups: [], nearMisses: [], allScored: [], altPct: 0 };

  // --- Compute RS values for normalization ---
  const rs24Arr = coins.map(c => c.ch24 - btc.ch24);
  const rsMean = rs24Arr.reduce((a, b) => a + b, 0) / rs24Arr.length;
  const rsStd = Math.sqrt(rs24Arr.reduce((a, v) => a + (v - rsMean) ** 2, 0) / rs24Arr.length) || 1;

  // --- Volume normalization ---
  const vols = coins.filter(c => c.vol24 > 0).map(c => c.vol24);
  const volMean = vols.length ? vols.reduce((a, b) => a + b, 0) / vols.length : 1;

  // --- Score each coin ---
  coins.forEach((c, i) => {
    // 1) Multi-TF Relative Strength
    const rs24 = c.ch24 - btc.ch24;
    const rs4h = c.ch4h !== null ? c.ch4h - btc.ch4h : rs24 * 0.5;
    const rs1h = c.ch1h !== null ? c.ch1h - btc.ch1h : rs4h * 0.5;
    c.rs24 = rs24; c.rs4h = rs4h; c.rs1h = rs1h;

    const rsZ = (rs24 - rsMean) / rsStd;
    const allSame = (rs1h >= 0 && rs4h >= 0 && rs24 >= 0) || (rs1h <= 0 && rs4h <= 0 && rs24 <= 0);
    const alignMult = allSame ? 1.4 : 1.0;
    const accel = allSame && ((rs24 > 0 && rs1h > rs4h && rs4h > rs24) || (rs24 < 0 && rs1h < rs4h && rs4h < rs24));
    const accelMult = accel ? 1.25 : 1.0;
    const rsScore = clamp(rsZ * 35 * alignMult * accelMult, -100, 100);

    // 2) Funding + Delta
    const fPct = c.fundingPct;
    const fSignal = -fPct;
    let fBase = clamp(fSignal / 0.08 * 100, -100, 100);
    const prev = History.prev(c.sym);
    let fDeltaBonus = 0;
    if (prev) {
      const prevF = prev.funding || 0;
      if (Math.sign(fPct) !== Math.sign(prevF) && Math.abs(fPct) > 0.005) {
        fDeltaBonus = sign(fSignal) * 25;
      } else if (Math.abs(fPct) > Math.abs(prevF) + 0.005) {
        fDeltaBonus = sign(fSignal) * 12;
      }
    }
    const fundScore = clamp(fBase + fDeltaBonus, -100, 100);
    c.fundingDelta = prev ? fPct - (prev.funding || 0) : 0;
    c.fundingFlip = prev ? Math.sign(fPct) !== Math.sign(prev.funding || 0) && Math.abs(fPct) > 0.003 : false;

    // 3) Volume Acceleration
    const v1h = c.vol1h || 0;
    const v4hHr = c.vol4h !== null ? c.vol4h / 4 : 0;
    const v24hHr = c.vol24 / 24;
    const volDir = sign(rs24);
    let volMag = 0;
    const volRatio = v24hHr > 0 ? v1h / v24hHr : 1;
    const isAccel = v1h > 0 && v4hHr > 0 && v1h > v4hHr && v4hHr > v24hHr;
    const isDecel = v1h > 0 && v4hHr > 0 && v1h < v4hHr && v4hHr < v24hHr;
    if (isAccel) volMag = clamp(volRatio * 20, 0, 100);
    else if (isDecel) volMag = clamp(volRatio * 8, 0, 40);
    else volMag = clamp(volRatio * 14, 0, 70);
    const volScore = volDir * volMag;
    c.volRatio = volRatio; c.isAccel = isAccel; c.isDecel = isDecel;

    // 4) Open Interest
    let oiScore = 0;
    const prevOi = prev?.oi || 0;
    const oiDelta = prevOi > 0 ? (c.oi - prevOi) / prevOi : 0;
    c.oiDelta = oiDelta;
    if (Math.abs(oiDelta) > 0.02) {
      const oiDir = (c.ch24 > 0 && oiDelta > 0) || (c.ch24 < 0 && oiDelta > 0) ? sign(rs24) : -sign(rs24) * 0.5;
      oiScore = oiDir * clamp(Math.abs(oiDelta) * 400, 0, 100);
    }

    // 5) Momentum
    const range = c.futHigh - c.futLow;
    let momScore = 0;
    c.rangePos = 0.5;
    if (range > 0) {
      c.rangePos = (c.futClose - c.futLow) / range;
      momScore = clamp((c.rangePos - 0.5) * 200, -100, 100);
    }

    // Composite
    const composite = (rsScore * C.W.rs) + (fundScore * C.W.funding) + (volScore * C.W.vol) + (oiScore * C.W.oi) + (momScore * C.W.mom);
    c.score = Math.round(composite);
    c.dir = composite >= 0 ? 'long' : 'short';
    c.absScore = Math.abs(c.score);
    c.signals = { rs: rsScore, funding: fundScore, vol: volScore, oi: oiScore, mom: momScore };

    // Save snapshot
    History.save(c.sym, {
      ts: Date.now(), score: c.score, funding: c.fundingPct,
      rs1h: c.rs1h, rs4h: c.rs4h, rs24: c.rs24, oi: c.oi
    });
  });

  // Correlation check
  const corrCount = coins.filter(c => Math.abs(c.rs24) <= 1).length;
  if (corrCount / coins.length > 0.8) { condition += '_corr'; threshold = Math.max(threshold, 45); }

  // Generate rationale
  coins.forEach(c => { c.rationale = makeRationale(c, btc); });

  // Filter, rank
  const setups = coins
    .filter(c => c.absScore >= threshold)
    .sort((a, b) => b.absScore - a.absScore)
    .slice(0, C.MAX_SETUPS);

  const nearMisses = coins
    .filter(c => c.absScore >= threshold - 10 && c.absScore < threshold)
    .sort((a, b) => b.absScore - a.absScore)
    .slice(0, 3);

  const altPct = Math.round((coins.filter(c => c.rs24 > 0).length / coins.length) * 100);

  const allScored = [...coins].sort((a, b) => a.mcap - b.mcap);

  return { btc, condition, threshold, setups, nearMisses, allScored, altPct };
}

// ═══════════════════════════════════════════════════════
//  RATIONALE ENGINE
// ═══════════════════════════════════════════════════════

function makeRationale(c, btc) {
  const sigs = [
    { k: 'rs', v: Math.abs(c.signals.rs) * C.W.rs },
    { k: 'funding', v: Math.abs(c.signals.funding) * C.W.funding },
    { k: 'vol', v: Math.abs(c.signals.vol) * C.W.vol },
    { k: 'oi', v: Math.abs(c.signals.oi) * C.W.oi },
    { k: 'mom', v: Math.abs(c.signals.mom) * C.W.mom }
  ].sort((a, b) => b.v - a.v);
  const dom = sigs[0].k, sec = sigs[1].k;
  const rs = c.rs24, fp = c.fundingPct, vr = c.volRatio;

  if (c.dir === 'long') {
    if (dom === 'rs') {
      const allAligned = c.rs1h > 0 && c.rs4h > 0 && c.rs24 > 0;
      if (allAligned && sec === 'funding' && fp < -0.005)
        return `Breaking away from BTC across all timeframes with shorts crowded \u2014 squeeze potential`;
      if (allAligned)
        return `Diverging from BTC on every timeframe \u2014 building its own trend`;
      return `Outperforming BTC by ${Math.abs(rs).toFixed(1)}% \u2014 relative strength emerging`;
    }
    if (dom === 'funding') {
      if (c.fundingFlip)
        return `Funding just flipped negative \u2014 shorts scrambling, reversal may be underway`;
      return `Shorts paying ${Math.abs(fp).toFixed(3)}% to stay short \u2014 crowded trade ready to unwind`;
    }
    if (dom === 'vol') {
      if (c.isAccel) return `Money pouring in \u2014 volume accelerating across timeframes`;
      return `${vr.toFixed(1)}x average volume on strength \u2014 institutional interest likely`;
    }
    if (dom === 'oi') return `New longs flooding in on strength \u2014 conviction building`;
    return `Pressing into session highs \u2014 buyers in control`;
  } else {
    if (dom === 'rs') {
      const allAligned = c.rs1h < 0 && c.rs4h < 0 && c.rs24 < 0;
      if (allAligned && sec === 'funding' && fp > 0.03)
        return `Weakening across all timeframes with overleveraged longs \u2014 breakdown risk`;
      if (allAligned)
        return `Deteriorating on every timeframe \u2014 structural underperformance`;
      return `Underperforming BTC by ${Math.abs(rs).toFixed(1)}% \u2014 relative weakness showing`;
    }
    if (dom === 'funding') {
      if (c.fundingFlip)
        return `Funding just flipped positive \u2014 longs piling in late, reversal risk`;
      return `Longs paying ${Math.abs(fp).toFixed(3)}% \u2014 overleveraged, unwinding likely`;
    }
    if (dom === 'vol') {
      if (c.isAccel) return `Selling on accelerating volume \u2014 distribution in progress`;
      return `Weakness on ${vr.toFixed(1)}x average volume \u2014 conviction behind the move`;
    }
    if (dom === 'oi') return `New shorts entering on weakness \u2014 bearish conviction building`;
    return `Stuck near session lows \u2014 sellers in control`;
  }
}

function makeBlocker(c, threshold) {
  const gap = threshold - c.absScore;
  const weakest = [
    { k: 'Relative strength', v: Math.abs(c.signals.rs) * C.W.rs },
    { k: 'Funding signal', v: Math.abs(c.signals.funding) * C.W.funding },
    { k: 'Volume', v: Math.abs(c.signals.vol) * C.W.vol },
    { k: 'Open interest', v: Math.abs(c.signals.oi) * C.W.oi },
    { k: 'Momentum', v: Math.abs(c.signals.mom) * C.W.mom }
  ].sort((a, b) => a.v - b.v)[0];
  return `${weakest.k} needs to strengthen (${gap} pts short)`;
}

// ═══════════════════════════════════════════════════════
//  RENDERING
// ═══════════════════════════════════════════════════════

function render(R) {
  if (!R) return;
  S.result = R; S.allScored = R.allScored;
  renderContext(R.btc, R.condition, R.threshold);
  renderCondBanner(R.btc, R.condition, R.threshold);
  renderWatchlist(R);
  renderSetups(R.setups, R.threshold);
  renderNearMisses(R.nearMisses, R.threshold);
  renderHeatmap(R.allScored);
  renderAltseason(R.altPct);
  renderDominance(R.btc);
  document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  document.getElementById('proxyNote').textContent = S.usingProxy ? 'Via CORS proxy \u00b7 ' : '';
}

function renderContext(btc, cond, thresh) {
  const el = document.getElementById('contextBar');
  const price = btc.price ? '$' + btc.price.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '\u2014';
  const ch = btc.ch24 !== undefined ? pct(btc.ch24) : '\u2014';
  const chCls = btc.ch24 >= 0 ? 'pos' : 'neg';
  const fgCls = btc.fgVal >= 60 ? 'pos' : btc.fgVal <= 40 ? 'neg' : 'neutral';
  const rangeLbl = btc.range > 4 ? 'Active' : btc.range > 2 ? 'Moderate' : 'Quiet';
  const rangeCls = btc.range > 4 ? 'pos' : btc.range > 2 ? 'warn' : 'neg';

  el.innerHTML = `
    <div class="context-item"><div class="context-label">Bitcoin</div><div class="context-value">${price}</div><div class="context-sub ${chCls}">${ch} (24h)</div></div>
    <div class="context-item"><div class="context-label">Fear &amp; Greed</div><div class="context-value ${fgCls}">${btc.fgVal || '\u2014'}</div><div class="context-sub neutral">${btc.fgLabel}</div></div>
    <div class="context-item"><div class="context-label">BTC Dominance</div><div class="context-value">${btc.dom ? btc.dom.toFixed(1) + '%' : '\u2014'}</div><div class="context-sub neutral">${btc.dom > 55 ? 'BTC-heavy' : btc.dom < 45 ? 'Alt-friendly' : 'Balanced'}</div></div>
    <div class="context-item"><div class="context-label">Volatility</div><div class="context-value ${rangeCls}">${rangeLbl}</div><div class="context-sub neutral">${btc.range.toFixed(1)}% range \u00b7 Threshold: ${thresh}</div></div>
  `;
}

function renderCondBanner(btc, cond, thresh) {
  const el = document.getElementById('condBanner');
  let cls, msg;
  if (cond.includes('low')) {
    cls = 'cond-low';
    msg = `\u26a0 Low volatility${cond.includes('corr') ? ' + high correlation' : ''} \u2014 consider sitting out or scaling down. Threshold raised to ${thresh}.`;
  } else if (cond.includes('moderate')) {
    cls = 'cond-moderate';
    msg = `\u25cb Moderate conditions${cond.includes('corr') ? ', high correlation' : ''} \u2014 be selective. Threshold at ${thresh}.`;
  } else if (btc.fgVal >= 80 || btc.fgVal <= 15) {
    cls = 'cond-extreme';
    msg = btc.fgVal >= 80 ? '\u26a0 Extreme greed \u2014 market euphoric, expect volatility' : '\u26a0 Extreme fear \u2014 contrarian opportunities may exist';
  } else {
    cls = 'cond-normal';
    msg = `\u2713 Normal conditions \u2014 standard setup quality required. Threshold: ${thresh}.`;
  }
  el.innerHTML = `<div class="cond-banner ${cls}">${msg}</div>`;
}

function renderWatchlist(R) {
  const el = document.getElementById('watchlistSection');
  const wl = Watchlist.getAll();
  if (wl.length === 0 && !R.setups.length) {
    el.innerHTML = `<div class="watchlist-section"><div class="watchlist-header"><div class="section-title">Watchlist</div><button class="btn" onclick="openModal()">+ Add</button></div><div class="wl-empty">No coins on your watchlist yet. Add from the heatmap or click + Add.</div></div>`;
    return;
  }
  if (wl.length === 0) {
    el.innerHTML = `<div class="watchlist-section"><div class="watchlist-header"><div class="section-title">Watchlist</div><button class="btn" onclick="openModal()">+ Add</button></div><div class="wl-empty">Click + Add or tap coins in the heatmap to track them.</div></div>`;
    return;
  }

  const cards = wl.map(sym => {
    const c = R.allScored.find(x => x.sym === sym);
    if (!c) return `<div class="wl-card"><div class="wl-sym">${sym}</div><div class="wl-row neutral">No data</div><button class="wl-remove" onclick="removeWl('${sym}')">&times;</button></div>`;
    return `<div class="wl-card" onclick="scrollToSetup('${sym}')">
      <button class="wl-remove" onclick="event.stopPropagation();removeWl('${sym}')">&times;</button>
      <div class="wl-sym">${c.sym}</div>
      <div class="wl-row"><span class="wl-dir ${c.dir}">${c.dir.toUpperCase()}</span><span class="wl-score ${c.dir === 'long' ? 'pos' : 'neg'}">${c.absScore}</span></div>
      <div class="wl-row"><span class="${c.ch24 >= 0 ? 'pos' : 'neg'}">${pct(c.ch24)}</span></div>
    </div>`;
  }).join('');

  el.innerHTML = `<div class="watchlist-section"><div class="watchlist-header"><div class="section-title">Watchlist</div><button class="btn" onclick="openModal()">+ Add</button></div><div class="watchlist-grid">${cards}</div></div>`;
}

function renderSetups(setups, thresh) {
  const el = document.getElementById('setups');
  document.getElementById('setupCount').textContent = setups.length;

  if (setups.length === 0) {
    el.innerHTML = `<div class="no-setups"><h3>No clear setups right now</h3><p>No altcoins are diverging strongly enough from BTC to warrant a trade. Threshold is at ${thresh}.</p></div>`;
    return;
  }

  el.innerHTML = setups.map(c => {
    const tr = History.trend(c.sym, thresh);
    const trendHtml = tr.isNew
      ? `<span class="new-tag">New</span> \u2014 appeared ${timeAgo(tr.age)}`
      : `${tr.label} \u2014 ${timeAgo(tr.age)}${tr.scoreDelta !== 0 ? `, <span class="trend-arrow ${tr.scoreDelta > 0 ? 'up' : 'down'}">${tr.scoreDelta > 0 ? '\u2191' : '\u2193'}${Math.abs(tr.scoreDelta)}</span>` : ''}`;

    const frCls = c.fundingPct < -0.005 ? 'pos' : c.fundingPct > 0.03 ? 'neg' : 'neutral';
    const rsCls = c.rs24 > 0 ? 'pos' : c.rs24 < 0 ? 'neg' : 'neutral';
    const momLbl = c.rangePos > 0.65 ? 'Strong' : c.rangePos < 0.35 ? 'Weak' : 'Neutral';
    const momCls = c.rangePos > 0.65 ? 'pos' : c.rangePos < 0.35 ? 'neg' : 'neutral';
    const oiLbl = c.oiDelta > 0.02 ? '\u2191' + (c.oiDelta * 100).toFixed(0) + '%' : c.oiDelta < -0.02 ? '\u2193' + Math.abs(c.oiDelta * 100).toFixed(0) + '%' : 'Flat';
    const oiCls = c.oiDelta > 0.02 ? 'pos' : c.oiDelta < -0.02 ? 'neg' : 'neutral';
    const volLbl = c.isAccel ? '\u2191 Accel' : c.isDecel ? '\u2193 Decel' : c.volRatio.toFixed(1) + 'x';
    const volCls = c.isAccel ? 'pos' : c.isDecel ? 'neg' : 'neutral';

    return `<div class="setup-card ${c.dir}${tr.isNew ? ' is-new' : ''}" id="setup-${c.sym}">
      <button class="dismiss-btn" onclick="dismiss('${c.sym}')" title="Hide ${c.sym}">&times;</button>
      <div class="setup-top">
        <div class="setup-left">
          <span class="dir-badge ${c.dir}">${c.dir.toUpperCase()}</span>
          <span class="setup-sym">${c.sym} <small>/USDT</small></span>
        </div>
        <div class="setup-score">
          <div class="score-val ${c.dir}">${c.absScore}</div>
          <div class="score-lbl">strength</div>
          <div class="score-bar"><div class="score-bar-fill ${c.dir}" style="width:${c.absScore}%"></div></div>
        </div>
      </div>
      <div class="trend-line">${trendHtml}</div>
      <div class="setup-rationale">"${c.rationale}"</div>
      <div class="setup-metrics">
        <div class="metric"><div class="metric-label">Funding</div><div class="metric-value ${frCls}">${c.fundingPct >= 0 ? '+' : ''}${c.fundingPct.toFixed(4)}%</div><div class="metric-sub">${c.fundingFlip ? 'Flipped!' : c.fundingDelta !== 0 ? (c.fundingDelta > 0 ? '\u2191' : '\u2193') + ' delta' : 'Stable'}</div></div>
        <div class="metric"><div class="metric-label">RS 24h</div><div class="metric-value ${rsCls}">${pct(c.rs24)}</div><div class="metric-sub">1h: ${c.rs1h !== null ? pct(c.rs1h) : 'n/a'}</div></div>
        <div class="metric"><div class="metric-label">Volume</div><div class="metric-value ${volCls}">${volLbl}</div><div class="metric-sub">${c.volRatio.toFixed(1)}x avg</div></div>
        <div class="metric"><div class="metric-label">Open Interest</div><div class="metric-value ${oiCls}">${oiLbl}</div><div class="metric-sub">${c.oi > 0 ? '$' + (c.oi / 1e6).toFixed(0) + 'M' : 'n/a'}</div></div>
        <div class="metric"><div class="metric-label">Momentum</div><div class="metric-value ${momCls}">${momLbl}</div><div class="metric-sub">${(c.rangePos * 100).toFixed(0)}% of range</div></div>
      </div>
      <div class="card-actions">
        ${Watchlist.has(c.sym) ? `<button class="btn" onclick="event.stopPropagation();removeWl('${c.sym}')">Watching \u2713</button>` : `<button class="btn" onclick="event.stopPropagation();addWl('${c.sym}')">+ Watch</button>`}
      </div>
    </div>`;
  }).join('');
}

function renderNearMisses(nm, thresh) {
  const el = document.getElementById('nearMisses');
  if (nm.length === 0) { el.innerHTML = ''; return; }
  el.innerHTML = `<div class="near-misses"><h4>Near Misses</h4>${nm.map(c => `<div class="nm-item"><span class="nm-sym">${c.sym}</span><span class="nm-score">${c.absScore}/${thresh}</span><span class="nm-reason">\u2014 ${makeBlocker(c, thresh)}</span></div>`).join('')}</div>`;
}

function renderHeatmap(coins) {
  const el = document.getElementById('heatmap');
  if (!coins || coins.length === 0) { el.innerHTML = ''; return; }
  el.innerHTML = coins.slice(0, 60).map(c => {
    const bg = fundingColor(c.fundingPct);
    return `<div class="hm-cell" style="background:${bg}" onclick="showPopover('${c.sym}',event)" title="${c.sym}"><div class="hm-sym">${c.sym}</div><div class="hm-rate">${c.fundingPct >= 0 ? '+' : ''}${(c.fundingPct * 100).toFixed(1)}bp</div></div>`;
  }).join('');
}

function fundingColor(rate) {
  const t = clamp(rate / 0.06, -1, 1);
  if (t <= 0) {
    const intensity = Math.abs(t);
    return `rgba(16,${Math.round(100 + intensity * 85)},${Math.round(80 + intensity * 49)},${0.2 + intensity * 0.5})`;
  } else {
    return `rgba(${Math.round(140 + t * 99)},${Math.round(68 - t * 40)},${Math.round(68 - t * 30)},${0.2 + t * 0.5})`;
  }
}

function renderAltseason(pct) {
  const fill = document.getElementById('altFill');
  const val = document.getElementById('altVal');
  const label = document.getElementById('altLabel');
  fill.style.width = pct + '%';
  val.textContent = pct + '%';
  if (pct >= 75) { fill.style.background = 'var(--green)'; val.style.color = 'var(--green)'; label.textContent = 'Altseason \u2014 majority outperforming BTC'; }
  else if (pct >= 50) { fill.style.background = 'var(--amber)'; val.style.color = 'var(--amber)'; label.textContent = 'Leaning alt-friendly \u2014 some strength showing'; }
  else if (pct >= 25) { fill.style.background = 'var(--amber)'; val.style.color = 'var(--text-dim)'; label.textContent = 'BTC-led market \u2014 alts generally lagging'; }
  else { fill.style.background = 'var(--red)'; val.style.color = 'var(--red)'; label.textContent = 'BTC dominance \u2014 most alts underperforming'; }
}

function renderDominance(btc) {
  document.getElementById('domVal').textContent = btc.dom ? btc.dom.toFixed(1) + '%' : '\u2014';
  const note = btc.dom > 58 ? 'High \u2014 capital concentrated in BTC' : btc.dom > 50 ? 'Moderate \u2014 some capital in alts' : 'Low \u2014 capital rotating to alts';
  document.getElementById('domNote').innerHTML = `<span class="neutral">${note}</span>`;
}

// ═══════════════════════════════════════════════════════
//  HEATMAP POPOVER
// ═══════════════════════════════════════════════════════

function showPopover(sym, ev) {
  ev.stopPropagation();
  const c = S.allScored?.find(x => x.sym === sym);
  if (!c) return;
  const pop = document.getElementById('hmPopover');
  const rsCls = c.rs24 > 0 ? 'pos' : c.rs24 < 0 ? 'neg' : 'neutral';
  const frCls = c.fundingPct < -0.005 ? 'pos' : c.fundingPct > 0.03 ? 'neg' : 'neutral';
  pop.innerHTML = `
    <div class="pop-header"><span class="pop-sym">${c.sym}/USDT</span><button class="pop-close" onclick="closePopover()">&times;</button></div>
    <div class="pop-row"><span class="pop-label">Price</span><span class="pop-val">$${c.price?.toLocaleString(undefined,{maximumFractionDigits:4}) || 'n/a'}</span></div>
    <div class="pop-row"><span class="pop-label">24h Change</span><span class="pop-val ${c.ch24 >= 0 ? 'pos' : 'neg'}">${pct(c.ch24)}</span></div>
    <div class="pop-row"><span class="pop-label">Funding</span><span class="pop-val ${frCls}">${c.fundingPct >= 0 ? '+' : ''}${c.fundingPct.toFixed(4)}%</span></div>
    <div class="pop-row"><span class="pop-label">RS vs BTC</span><span class="pop-val ${rsCls}">${pct(c.rs24)}</span></div>
    <div class="pop-row"><span class="pop-label">Volume</span><span class="pop-val">${c.volRatio.toFixed(1)}x avg</span></div>
    <div class="pop-row"><span class="pop-label">Score</span><span class="pop-val">${c.absScore} (${c.dir.toUpperCase()})</span></div>
    <div class="pop-actions">
      ${Watchlist.has(c.sym) ? `<button class="btn" onclick="removeWl('${c.sym}');closePopover()">Remove from watchlist</button>` : `<button class="btn" onclick="addWl('${c.sym}');closePopover()">+ Add to watchlist</button>`}
    </div>`;
  pop.classList.add('visible');
  const rect = pop.getBoundingClientRect();
  let x = ev.clientX + 10, y = ev.clientY + 10;
  if (x + 240 > window.innerWidth) x = ev.clientX - 250;
  if (y + 280 > window.innerHeight) y = ev.clientY - 290;
  pop.style.left = Math.max(8, x) + 'px';
  pop.style.top = Math.max(8, y) + 'px';
}

function closePopover() { document.getElementById('hmPopover').classList.remove('visible'); }
document.addEventListener('click', (e) => {
  const pop = document.getElementById('hmPopover');
  if (pop.classList.contains('visible') && !pop.contains(e.target) && !e.target.closest('.hm-cell')) closePopover();
});

// ═══════════════════════════════════════════════════════
//  WATCHLIST MODAL
// ═══════════════════════════════════════════════════════

function openModal() {
  document.getElementById('wlModal').classList.add('visible');
  const inp = document.getElementById('wlSearch');
  inp.value = '';
  inp.focus();
  filterModal('');
}

function closeModal() { document.getElementById('wlModal').classList.remove('visible'); }

document.getElementById('wlSearch').addEventListener('input', (e) => filterModal(e.target.value));
document.getElementById('wlModal').addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) closeModal(); });

function filterModal(q) {
  const el = document.getElementById('wlResults');
  const coins = S.allScored || [];
  const query = q.toUpperCase();
  const matches = coins.filter(c => c.sym.includes(query) || c.name.toLowerCase().includes(q.toLowerCase())).slice(0, 12);
  el.innerHTML = matches.map(c => `<div class="modal-item" onclick="addWl('${c.sym}');closeModal()"><span><span class="mi-sym">${c.sym}</span> <span class="mi-name">${c.name}</span></span><span class="${c.ch24 >= 0 ? 'pos' : 'neg'}">${pct(c.ch24)}</span></div>`).join('');
}

// ═══════════════════════════════════════════════════════
//  INTERACTIONS
// ═══════════════════════════════════════════════════════

function addWl(sym) { Watchlist.add(sym); if (S.result) render(S.result); }
function removeWl(sym) { Watchlist.remove(sym); if (S.result) render(S.result); }
function scrollToSetup(sym) {
  const el = document.getElementById('setup-' + sym);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function dismiss(sym) {
  S.excluded.push(sym);
  try { localStorage.setItem('scanner_v2_excl', JSON.stringify(S.excluded)); } catch {}
  if (S.raw) { const r = analyze(S.raw); render(r); }
}

function toggleAuto() {
  S.auto = !S.auto;
  const btn = document.getElementById('autoBtn');
  if (S.auto) { btn.classList.add('active'); btn.innerHTML = '<span class="dot"></span> Auto'; schedule(); }
  else { btn.classList.remove('active'); btn.innerHTML = 'Auto'; clearTimeout(S.timer); document.getElementById('countdown').textContent = ''; }
}

function schedule() {
  if (!S.auto) return;
  S.nextRefresh = Date.now() + C.REFRESH;
  clearTimeout(S.timer);
  S.timer = setTimeout(run, C.REFRESH);
  tick();
}

function tick() {
  if (!S.auto) return;
  const rem = Math.max(0, S.nextRefresh - Date.now());
  const m = Math.floor(rem / 60000), s = Math.floor((rem % 60000) / 1000);
  document.getElementById('countdown').textContent = `${m}:${s.toString().padStart(2, '0')}`;
  if (rem > 0) requestAnimationFrame(tick);
}

async function manualRefresh() {
  const btn = document.getElementById('refreshBtn');
  btn.textContent = '...'; btn.disabled = true;
  await run();
  btn.textContent = 'Refresh'; btn.disabled = false;
}

function showError(msg) {
  const el = document.getElementById('errorToast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 4000);
}

// ═══════════════════════════════════════════════════════
//  MAIN LOOP
// ═══════════════════════════════════════════════════════

async function run() {
  try {
    const raw = await fetchAll();
    S.raw = raw;
    if (!raw.spot24 && !raw.fut24 && !raw.cgMkt) {
      showError('Could not reach any data source. Check your connection.');
      return;
    }
    if (!raw.spot1h) showError('1h rolling window unavailable \u2014 multi-TF RS limited');
    if (!raw.funding) showError('Funding rate data unavailable');
    if (!raw.cgDeriv) showError('Open interest data unavailable');

    const result = analyze(raw);
    render(result);
    History.prune();
  } catch (e) {
    console.error(e);
    showError('Scan failed: ' + e.message);
  } finally {
    document.getElementById('loader').classList.add('hidden');
    schedule();
  }
}

// Init
run();
</script>
</body>
</html>
